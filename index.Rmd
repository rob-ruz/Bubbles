---
title: "Caso"
author: "Roberto Ruz Campos"
date: "30/11/2019"
output:
  html_document:
    df_print: paged
---  

```{r loading libraries, message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(readxl)
library(tsibble)
library(rlang)
library(broom)
library(slide)
```

```{r importing Compustat daily data}
raw_data <-
  left_join(
    x = read_csv(
      file = "Compustat_Global_Daily.csv",
      col_types = cols(
        sedol = col_character(),
        datadate = col_date(format = "%Y%m%d")
      )
    ),
    y = read_xlsx(
      path = "Sectores_GICS_BMV.xlsx",
      sheet = "Sectores",
      range = "A1:B292",
      col_types = c("text")
    ),
    by = "gvkey"
  )
```

```{r importing market index data}
mkt_index <-
  read_csv(
    file = "Compustat_Index.csv",
    col_types = cols(
      gvkeyx = col_character(),
      datadate = col_date(format = "%Y%m%d")
    )
  ) %>%
  filter(gvkeyx == "150039") %>%
  mutate(mes = yearmonth(datadate)) %>%
  select(mes, prccm)
```

```{r processing raw data} 
# Aquí agregaríamos algún otro filtro que nos falte
daily_raw_data <- raw_data %>%
  filter(
    exchg == 208,
    !curcdd %in% "USD",
    !is.na(curcdd)
  ) %>%
  unite(
    col = gvkey_iid,
    1:2,
    remove = FALSE
  ) %>%
  mutate(
    prccd = if_else(curcdd == "MXP", prccd / 1000, prccd),
    adj_price = (prccd / ajexdi) * trfd,
    mv = prccd * cshoc / 1000000,
    mes = yearmonth(datadate)
  ) %>%
  select(gvkey_iid, gvkey, iid, mes, conm, sector, adj_price, mv)
```

```{r converting to monthly data}
monthly_raw_data <- daily_raw_data %>%
  group_by(
    gvkey_iid, 
    mes
  ) %>%
  summarise_all(~ last(.))
```

```{r filtering out iids}
keep_iids <- monthly_raw_data %>%
  group_by(gvkey, iid) %>%
  summarise(avg_mv = mean(mv, na.rm = TRUE)) %>%
  filter(n_distinct(iid) > 1) %>% 
  top_n(1, avg_mv) %>% 
  unite(col = gvkey_iid, 1:2) %>% 
  pull(gvkey_iid)

monthly_data_inc <- monthly_raw_data %>% 
  group_by(gvkey) %>% 
  filter(
    n_distinct(iid) == 1 |
    gvkey_iid %in% keep_iids
  ) %>% 
  ungroup()
```

```{r filling gaps}
monthly_data <- monthly_data_inc %>%
  as_tsibble(
    key = gvkey_iid,
    index = mes
  ) %>%
  fill_gaps() %>% # Existe la opción de rellenar con alguna función que interpole
  fill(everything(), .direction = "down") %>% # contrapuesto a lo que tomar el valor anterior
  select(-c(gvkey, iid))
```

```{r calculating rolling betas}
beta <- monthly_data %>%
  group_by(gvkey_iid) %>%
  mutate(
    returns = adj_price / lag(adj_price) - 1,
    adj_price = NULL
  ) %>%
  drop_na() %>%
  nest(datos = c(mes, returns, mv)) %>% 
  mutate(
    datos = map(
      datos,
      ~ inner_join(
        .x,
        mutate(
          mkt_index,
          mkt_returns = prccm / lag(prccm) - 1,
          prccm = NULL
        ),
        by = "mes"
      ) %>%
        mutate(
          rolling = slide(
            .,
            ~ lm(returns ~ mkt_returns, data = .),
            .before = 36,
            .complete = TRUE
          ), # %>% purrr::modify(tidy)
          rolling = purrr::modify(rolling, tidy),
        ) %>%
        select(mes, rolling) %>%
        unnest(rolling)
    )
  ) 



beta_beta <- beta %>%
  mutate(
    datos = map(
      datos,
      ~ filter(
        .x,
        term == "mkt_returns"
      ) 
    ),
    n = map_dbl(datos, ~ length(.[[1]]))
  )


beta_beta <- filter(beta_beta, n > 0) 
beta_beta <- mutate(beta_beta, datos = map(datos, select, mes, beta = estimate))
beta_beta$datos[[5]]
sum(beta_beta$n)

beta_beta%>% 
  unnest(datos) %>% 
  pivot_wider(
    id_cols = mes, 
    names_from = gvkey_iid,
    values_from = beta,
    #values_fn = list(beta = length)
    values_fn = list(beta = sum)
  ) %>% mutate(mes = yearmonth(mes)) %>% View()
  # ) %>% select(-1) %>% map_dbl(~sum(!is.na(.), na.rm = T)) %>% sum


```

## Rendimientos Equally weighted

```{r}
returns_sector_ew <- datos_mensuales %>% 
  group_by(gvkey_iid) %>% 
  select(gvkey_iid, datadate, conm, BMV, adj_price, mv, mes) %>% 
  mutate(!!!lagged_returns(adj_price)) %>% 
  group_by(BMV) %>% 
  arrange(conm, datadate) %>% 
  group_split()
  
returns_sector_ew <- set_names(returns_sector_ew, map_chr(returns_sector_ew, ~ .x$BMV[[1]]))

# returns_sector_ew1 %>%
#   map(
#     ~ index_by(.x) %>%
#       select(gvkey_iid, mes, Return_12) %>%
#       pivot_wider(
#         names_from = gvkey_iid,
#         values_from = Return_12
#       )
#   ) %>%
#   `[[`(1) %>%
#   ungroup() %>%
#   arrange(mes) %>%
#   slice(365) %>%
#   select(-1) %>%
#   map_dbl(~.x) %>% mean(na.rm=T) %>% View()

returns_sector_ew1  <- map(
  .x = returns_sector_ew,
  .f = ~ summarise_at(
    .tbl = index_by(.x),
    .vars = vars(starts_with("Return")),
    .funs = ~ mean(., na.rm = TRUE)
  ) 
) #%>% map(~left_join(.x, mkt_rets))
```

```{r}
returns_sector_ew <- function(lag, umbral) {
lag <- enquo(lag)
umbral <- enquo(umbral)
datos_mensuales %>%
  group_by(gvkey_iid) %>%
  select(gvkey_iid, datadate, conm, sector, adj_price, mv, mes) %>%
  mutate(
    return = adj_price / lag(adj_price, !!lag) - 1,
    return5 = adj_price / lag(adj_price, 60) - 1
  ) %>%
  group_by(sector) %>%
  arrange(conm, datadate) %>%
  group_split() %>%
  set_names(., map_chr(., ~ .x$sector[[1]])) %>%
  map(
    ~ index_by(.) %>%
      summarise(
        sector_rend = mean(return, na.rm = T),
        sector_rend5 = mean(return5, na.rm = T)
      )
  ) %>%
  map(
    ~ left_join(
      .,
      mkt_index %>%
        mutate(
          mkt_rend = prccm / lag(prccm, !!lag) - 1,
          prccm = NULL
        )
    ) %>%
      mutate(net_mkt_ret = sector_rend - mkt_rend) %>%
      select(-mkt_rend) %>%
      mutate(id_up = if_else(sector_rend >= !!umbral & net_mkt_ret >= !!umbral, 1, 0))
  )
}

returns_sector_ew(24, 1)
```

```{r creating portfolio returns functions}
lagged_returns <- function(var, name, ...) {
  var <- enquo(var)
  name <- enquo(name)
  indices <- c(...)
    map(
      indices,
      ~ quo(!!var / lag(!!var, !!.x) - 1)
    ) %>% 
    set_names(sprintf("%s_ret_%d", quo_text(name), indices))
}


make_returns <- function(df, var = adj_price, lag) {
  lag <- enquo(lag)
  var <- enquo(var)
  mutate(
    df,
    return = !!var / lag(!!var, !!lag) - 1,
    !!var := NULL
  )
}

make_returns2 <- function(var = adj_price, lag) {
  lag <- enquo(lag)
  var <- enquo(var)

  quos(
    !!var / lag(!!var, !!lag) - 1,
    NULL
  ) %>% 
    set_names(c("returns", var))
}

make_returns2(lag =60)

ew_rets <- function(df, lag) {
  lag <- enquo(lag)
  df %>%
    group_by(gvkey_iid) %>%
    mutate(return = adj_price / lag(adj_price, !!lag) - 1) %>%
    group_by(sector) %>%
    index_by(mes) %>%
    summarise(pf_ret = mean(return, na.rm = TRUE))
}

vw_rets <- function(df, ...) {
  df %>%
    group_by(sector) %>%
    index_by(mes) %>%
    mutate(wt = mv / sum(mv)) %>%
    summarise(pf_val = sum(adj_price * wt)) %>%
    group_by(sector) %>% 
    mutate(
      !!!lagged_returns(pf_val, pf, ...),
      pf_val = NULL
    ) 
}
```

```{r analyzing bubbles}
vw_rets(monthly_data, 24, 60) %>% 
  group_split() %>% 
  # pivot_wider(
  #   names_from = sector,
  #   values_from = pf_ret
  # ) %>% 
  map(
  ~ left_join(
      x = .,
      y = mutate(mkt_index, !!!lagged_returns(var = prccm, mkt, 24, 60 ), prccm = NULL),
      by = "mes"
    ))# %>% 
    mutate(
      net_mkt_ret = Returns_24 - return,
      return = NULL
    )
  )
```